# uu_framework Docker Compose Configuration
# Use this for local development and building

services:
  # Full build service
  build:
    build:
      context: ../..
      dockerfile: uu_framework/docker/Dockerfile
    volumes:
      - ../../clase:/app/clase                # Mount content (writable for z_documentacion)
      - ../../_site:/app/_site                # Output directory
      - ../../uu_framework/config:/app/uu_framework/config:ro  # Config
      - ../../uu_framework/docs:/app/uu_framework/docs:ro  # Documentation source
      - ../../uu_framework/eleventy/_data:/app/uu_framework/eleventy/_data  # Data files
      - ../../uu_framework/eleventy/_includes:/app/uu_framework/eleventy/_includes:ro  # Templates
      - ../../uu_framework/eleventy/tailwind.config.js:/app/uu_framework/eleventy/tailwind.config.js:ro  # Tailwind config
      - ../../uu_framework/eleventy/src:/app/uu_framework/eleventy/src:ro  # CSS source
    command: ["sh", "-c", "python3 uu_framework/scripts/preprocess.py && npx @11ty/eleventy --config=uu_framework/eleventy/.eleventy.js && mkdir -p _site/css/themes && npx tailwindcss -c uu_framework/eleventy/tailwind.config.js -i uu_framework/eleventy/src/css/main.css -o _site/css/styles.css --minify && cp uu_framework/eleventy/src/css/themes/*.css _site/css/themes/"]

  # Development server with hot reload
  dev:
    build:
      context: ../..
      dockerfile: uu_framework/docker/Dockerfile
    volumes:
      - ../../clase:/app/clase                # Mount content (writable for z_documentacion)
      - ../../_site:/app/_site
      - ../../uu_framework/config:/app/uu_framework/config:ro
      - ../../uu_framework/docs:/app/uu_framework/docs:ro  # Documentation source
      - ../../uu_framework/eleventy/_data:/app/uu_framework/eleventy/_data
      - ../../uu_framework/eleventy/_includes:/app/uu_framework/eleventy/_includes:ro
      - ../../uu_framework/eleventy/src:/app/uu_framework/eleventy/src:ro
      - ../../uu_framework/eleventy/tailwind.config.js:/app/uu_framework/eleventy/tailwind.config.js:ro
    ports:
      - "3000:3000"
    command: >
      sh -c "python3 uu_framework/scripts/preprocess.py &&
             mkdir -p _site/css/themes &&
             npx tailwindcss -c uu_framework/eleventy/tailwind.config.js -i uu_framework/eleventy/src/css/main.css -o _site/css/styles.css &&
             cp uu_framework/eleventy/src/css/themes/*.css _site/css/themes/ &&
             npx @11ty/eleventy --config=uu_framework/eleventy/.eleventy.js --serve --port=3000"
    stdin_open: true
    tty: true

  # Preprocessing only (for debugging)
  preprocess:
    build:
      context: ../..
      dockerfile: uu_framework/docker/Dockerfile
    volumes:
      - ../../clase:/app/clase                # Mount content (writable for z_documentacion)
      - ../../uu_framework/docs:/app/uu_framework/docs:ro  # Documentation source
      - ../../uu_framework/eleventy/_data:/app/uu_framework/eleventy/_data
      - ../../uu_framework/config:/app/uu_framework/config:ro
    command: ["sh", "-c", "python3 uu_framework/scripts/preprocess.py --verbose"]
